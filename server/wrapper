import { Version } from '@microsoft/sp-core-library';
import {
  type IPropertyPaneConfiguration,
  PropertyPaneTextField
} from '@microsoft/sp-property-pane';
import { BaseClientSideWebPart } from '@microsoft/sp-webpart-base';

// Import assets
import htmlContent from './assets/content.html';
import './assets/styles.css';
import './assets/init.js';

// Import configuration
import { 
  EXTERNAL_CSS, 
  EXTERNAL_JS, 
  RELATIVE_CSS, 
  RELATIVE_JS 
} from './config/external-resources';

// Import styles
import styles from './ClassicWrapperWebPart.module.scss';

export interface IClassicWrapperWebPartProps {
  description: string;
}

export default class ClassicWrapperWebPart extends BaseClientSideWebPart<IClassicWrapperWebPartProps> {
  
  private loadedScripts: Set<string> = new Set();
  private loadedStyles: Set<string> = new Set();
  private isInitialized: boolean = false;

  public async render(): Promise<void> {
    // Show loading indicator
    this.domElement.innerHTML = `
      <div class="${styles.classicWrapper}">
        <div class="${styles.loading}">
          <div class="${styles.spinner}"></div>
          <p>Loading application...</p>
        </div>
        <div id="classic-content" style="display:none;"></div>
      </div>
    `;

    try {
      console.log('Starting Classic Wrapper initialization...');

      // Step 1: Initialize SharePoint Context
      this.initializeSharePointContext();

      // Step 2: Load all CSS files (non-blocking)
      this.loadAllStyles();

      // Step 3: Load all JavaScript files (in order, blocking)
      await this.loadAllScripts();

      // Step 4: Ensure SharePoint JSOM is loaded
      await this.ensureSharePointJSOM();

      // Step 5: Inject HTML content
      this.injectHTMLContent();

      // Step 6: Initialize classic code
      await this.initializeClassicCode();

      // Hide loading, show content
      const loading = this.domElement.querySelector(`.${styles.loading}`) as HTMLElement;
      const content = this.domElement.querySelector('#classic-content') as HTMLElement;
      
      if (loading) loading.style.display = 'none';
      if (content) content.style.display = 'block';

      console.log('Classic Wrapper loaded successfully');

    } catch (error) {
      console.error('Error loading classic wrapper:', error);
      this.showError(error.message);
    }
  }

  private initializeSharePointContext(): void {
    const webUrl = this.context.pageContext.web.absoluteUrl;
    
    // Set up _spPageContextInfo for classic code compatibility
    (window as any)._spPageContextInfo = {
      webAbsoluteUrl: webUrl,
      webServerRelativeUrl: this.context.pageContext.web.serverRelativeUrl,
      siteAbsoluteUrl: this.context.pageContext.site.absoluteUrl,
      siteServerRelativeUrl: this.context.pageContext.site.serverRelativeUrl,
      userId: this.context.pageContext.legacyPageContext?.userId || this.context.pageContext.aadInfo?.userId?.toString(),
      userLoginName: this.context.pageContext.user.loginName,
      userDisplayName: this.context.pageContext.user.displayName,
      userEmail: this.context.pageContext.user.email,
      currentLanguage: this.context.pageContext.cultureInfo.currentUICultureName,
      currentCultureName: this.context.pageContext.cultureInfo.currentCultureName,
      systemUserKey: this.context.pageContext.legacyPageContext?.systemUserKey
    };

    console.log('SharePoint context initialized:', (window as any)._spPageContextInfo);
  }

  private loadAllStyles(): void {
    const webUrl = this.context.pageContext.web.absoluteUrl;

    console.log('Loading external CSS files...');

    // Load external CSS from CDN
    EXTERNAL_CSS.forEach(resource => {
      this.loadStylesheet(resource.url);
    });

    // Load SharePoint relative CSS
    RELATIVE_CSS.forEach(relativePath => {
      const fullUrl = `${webUrl}${relativePath}`;
      this.loadStylesheet(fullUrl);
    });
  }

  private loadStylesheet(url: string): void {
    if (!this.loadedStyles.has(url)) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = url;
      link.onload = () => console.log(`CSS loaded: ${url}`);
      link.onerror = () => console.warn(`Failed to load CSS: ${url}`);
      document.head.appendChild(link);
      this.loadedStyles.add(url);
    }
  }

  private async loadAllScripts(): Promise<void> {
    const webUrl = this.context.pageContext.web.absoluteUrl;

    console.log('Loading external JavaScript files...');

    // Load external scripts in order
    const externalScripts = EXTERNAL_JS.sort((a, b) => a.order - b.order);
    for (const resource of externalScripts) {
      await this.loadScript(resource.url);
    }

    // Load SharePoint relative scripts
    for (const relativePath of RELATIVE_JS) {
      const fullUrl = `${webUrl}${relativePath}`;
      await this.loadScript(fullUrl);
    }

    console.log('All scripts loaded successfully');
  }

  private loadScript(url: string): Promise<void> {
    if (this.loadedScripts.has(url)) {
      console.log(`Script already loaded: ${url}`);
      return Promise.resolve();
    }

    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = url;
      script.async = false; // Maintain order
      
      script.onload = () => {
        console.log(`Script loaded: ${url}`);
        this.loadedScripts.add(url);
        resolve();
      };
      
      script.onerror = () => {
        console.error(`Failed to load script: ${url}`);
        reject(new Error(`Failed to load script: ${url}`));
      };
      
      document.head.appendChild(script);
    });
  }

  private async ensureSharePointJSOM(): Promise<void> {
    // Check if SP is already loaded
    if ((window as any).SP && (window as any).SP.ClientContext) {
      console.log('SharePoint JSOM already loaded');
      return Promise.resolve();
    }

    console.log('Loading SharePoint JSOM...');

    const webUrl = this.context.pageContext.web.absoluteUrl;

    try {
      // Load SP.Runtime.js
      await this.loadScript(`${webUrl}/_layouts/15/SP.Runtime.js`);
      
      // Load SP.js
      await this.loadScript(`${webUrl}/_layouts/15/SP.js`);

      console.log('SharePoint JSOM loaded successfully');
    } catch (error) {
      console.error('Failed to load SharePoint JSOM:', error);
      throw error;
    }
  }

  private injectHTMLContent(): void {
    const container = this.domElement.querySelector('#classic-content');
    if (container) {
      container.innerHTML = htmlContent;
      console.log('HTML content injected');
    }
  }

  private async initializeClassicCode(): Promise<void> {
    if (this.isInitialized) {
      console.log('Classic code already initialized');
      return;
    }

    // Wait a moment for DOM to be ready
    await new Promise(resolve => setTimeout(resolve, 100));

    try {
      // Call the initialization function from init.js
      if ((window as any).initClassicApp && typeof (window as any).initClassicApp === 'function') {
        console.log('Calling initClassicApp()...');
        (window as any).initClassicApp();
        this.isInitialized = true;
        console.log('Classic app initialized successfully');
      } else {
        console.warn('initClassicApp function not found on window object');
        console.warn('Make sure your init.js file exports: window.initClassicApp = initializeClassicApp;');
      }
    } catch (error) {
      console.error('Error initializing classic code:', error);
      throw error;
    }
  }

  private showError(message: string): void {
    this.domElement.innerHTML = `
      <div class="${styles.classicWrapper}">
        <div class="${styles.error}">
          <h3>Error Loading Application</h3>
          <p>${message}</p>
          <p><small>Check browser console for details</small></p>
        </div>
      </div>
    `;
  }

  protected onDispose(): void {
    this.isInitialized = false;
    super.onDispose();
  }

  protected get dataVersion(): Version {
    return Version.parse('1.0');
  }

  protected getPropertyPaneConfiguration(): IPropertyPaneConfiguration {
    return {
      pages: [
        {
          header: {
            description: 'Classic Wrapper Settings'
          },
          groups: [
            {
              groupName: 'Basic Settings',
              groupFields: [
                PropertyPaneTextField('description', {
                  label: 'Description Field'
                })
              ]
            }
          ]
        }
      ]
    };
  }
}
